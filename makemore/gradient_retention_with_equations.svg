<svg viewBox="0 0 1100 900" xmlns="http://www.w3.org/2000/svg">
  <!-- Title -->
  <text x="550" y="30" font-size="24" font-weight="bold" text-anchor="middle" fill="#333">
    Gradient Retention: Micrograd vs PyTorch (with equations)
  </text>

  <!-- Micrograd Section -->
  <text x="275" y="70" font-size="18" font-weight="bold" text-anchor="middle" fill="#2E7D32">
    Micrograd (keeps ALL gradients)
  </text>

  <!-- PyTorch Default Section -->
  <text x="825" y="70" font-size="18" font-weight="bold" text-anchor="middle" fill="#1976D2">
    PyTorch Default (keeps LEAF gradients only)
  </text>

  <!-- Micrograd Graph -->
  <g id="micrograd">
    <!-- W1 -->
    <circle cx="150" cy="130" r="30" fill="#4CAF50" stroke="#2E7D32" stroke-width="2"/>
    <text x="150" y="135" font-size="14" font-weight="bold" text-anchor="middle" fill="white">W1</text>
    <text x="150" y="175" font-size="10" text-anchor="middle" fill="#2E7D32" font-weight="bold">✓ .grad</text>
    <text x="80" y="135" font-size="11" text-anchor="end" fill="#666">(leaf)</text>

    <!-- emb -->
    <circle cx="150" cy="220" r="30" fill="#4CAF50" stroke="#2E7D32" stroke-width="2"/>
    <text x="150" y="225" font-size="14" font-weight="bold" text-anchor="middle" fill="white">emb</text>
    <text x="150" y="265" font-size="10" text-anchor="middle" fill="#2E7D32" font-weight="bold">✓ .grad</text>
    <text x="80" y="225" font-size="11" text-anchor="end" fill="#666">(leaf)</text>

    <!-- h1 -->
    <circle cx="280" cy="175" r="35" fill="#66BB6A" stroke="#2E7D32" stroke-width="2"/>
    <text x="280" y="180" font-size="14" font-weight="bold" text-anchor="middle" fill="white">h1</text>
    <text x="280" y="225" font-size="10" text-anchor="middle" fill="#2E7D32" font-weight="bold">✓ .grad</text>
    <text x="280" y="150" font-size="10" text-anchor="middle" fill="#1565C0" font-style="italic">emb @ W1 + b1</text>

    <!-- h1_act -->
    <circle cx="410" cy="175" r="35" fill="#66BB6A" stroke="#2E7D32" stroke-width="2"/>
    <text x="410" y="175" font-size="12" font-weight="bold" text-anchor="middle" fill="white">h1_act</text>
    <text x="410" y="225" font-size="10" text-anchor="middle" fill="#2E7D32" font-weight="bold">✓ .grad</text>
    <text x="410" y="150" font-size="10" text-anchor="middle" fill="#1565C0" font-style="italic">tanh(h1)</text>

    <!-- W2 -->
    <circle cx="410" cy="280" r="30" fill="#4CAF50" stroke="#2E7D32" stroke-width="2"/>
    <text x="410" y="285" font-size="14" font-weight="bold" text-anchor="middle" fill="white">W2</text>
    <text x="410" y="325" font-size="10" text-anchor="middle" fill="#2E7D32" font-weight="bold">✓ .grad</text>
    <text x="480" y="285" font-size="11" text-anchor="start" fill="#666">(leaf)</text>

    <!-- logits -->
    <circle cx="280" cy="360" r="35" fill="#66BB6A" stroke="#2E7D32" stroke-width="2"/>
    <text x="280" y="365" font-size="14" font-weight="bold" text-anchor="middle" fill="white">logits</text>
    <text x="280" y="410" font-size="10" text-anchor="middle" fill="#2E7D32" font-weight="bold">✓ .grad</text>
    <text x="280" y="335" font-size="10" text-anchor="middle" fill="#1565C0" font-style="italic">h1_act @ W2 + b2</text>

    <!-- loss -->
    <circle cx="280" cy="470" r="35" fill="#66BB6A" stroke="#2E7D32" stroke-width="2"/>
    <text x="280" y="475" font-size="14" font-weight="bold" text-anchor="middle" fill="white">loss</text>
    <text x="280" y="520" font-size="10" text-anchor="middle" fill="#2E7D32" font-weight="bold">✓ .grad</text>
    <text x="280" y="445" font-size="10" text-anchor="middle" fill="#1565C0" font-style="italic">cross_entropy(logits)</text>

    <!-- Edges -->
    <line x1="175" y1="140" x2="250" y2="165" stroke="#2E7D32" stroke-width="2" marker-end="url(#arrowgreen)"/>
    <line x1="175" y1="210" x2="250" y2="185" stroke="#2E7D32" stroke-width="2" marker-end="url(#arrowgreen)"/>
    <line x1="315" y1="175" x2="375" y2="175" stroke="#2E7D32" stroke-width="2" marker-end="url(#arrowgreen)"/>
    <line x1="405" y1="210" x2="290" y2="330" stroke="#2E7D32" stroke-width="2" marker-end="url(#arrowgreen)"/>
    <line x1="395" y1="295" x2="295" y2="340" stroke="#2E7D32" stroke-width="2" marker-end="url(#arrowgreen)"/>
    <line x1="280" y1="395" x2="280" y2="435" stroke="#2E7D32" stroke-width="2" marker-end="url(#arrowgreen)"/>

    <!-- Backprop flow annotation -->
    <text x="50" y="470" font-size="11" font-weight="bold" text-anchor="start" fill="#E65100">Backprop ↑</text>
    <line x1="50" y1="450" x2="50" y2="150" stroke="#E65100" stroke-width="2" marker-end="url(#arroworange)" stroke-dasharray="5,5"/>

    <!-- Legend -->
    <rect x="100" y="560" width="350" height="90" fill="#E8F5E9" stroke="#2E7D32" stroke-width="2" rx="5"/>
    <text x="275" y="585" font-size="13" font-weight="bold" text-anchor="middle" fill="#2E7D32">
      ALL nodes keep gradients
    </text>
    <text x="275" y="605" font-size="11" text-anchor="middle" fill="#333">
      Every Value object stores .grad
    </text>
    <circle cx="180" cy="625" r="8" fill="#4CAF50" stroke="#2E7D32" stroke-width="1"/>
    <text x="200" y="630" font-size="11" text-anchor="start" fill="#333">Leaf (parameters): .grad ✓</text>
    <circle cx="180" cy="642" r="8" fill="#66BB6A" stroke="#2E7D32" stroke-width="1"/>
    <text x="200" y="647" font-size="11" text-anchor="start" fill="#333">Intermediate: .grad ✓</text>
  </g>

  <!-- PyTorch Graph -->
  <g id="pytorch">
    <!-- W1 -->
    <circle cx="700" cy="130" r="30" fill="#1976D2" stroke="#0D47A1" stroke-width="2"/>
    <text x="700" y="135" font-size="14" font-weight="bold" text-anchor="middle" fill="white">W1</text>
    <text x="700" y="175" font-size="10" text-anchor="middle" fill="#1976D2" font-weight="bold">✓ .grad</text>
    <text x="630" y="135" font-size="11" text-anchor="end" fill="#666">(leaf)</text>

    <!-- emb -->
    <circle cx="700" cy="220" r="30" fill="#1976D2" stroke="#0D47A1" stroke-width="2"/>
    <text x="700" y="225" font-size="14" font-weight="bold" text-anchor="middle" fill="white">emb</text>
    <text x="700" y="265" font-size="10" text-anchor="middle" fill="#1976D2" font-weight="bold">✓ .grad</text>
    <text x="630" y="225" font-size="11" text-anchor="end" fill="#666">(leaf)</text>

    <!-- h1 -->
    <circle cx="830" cy="175" r="35" fill="#CCCCCC" stroke="#999999" stroke-width="2"/>
    <text x="830" y="180" font-size="14" font-weight="bold" text-anchor="middle" fill="#666">h1</text>
    <text x="830" y="225" font-size="10" text-anchor="middle" fill="#D32F2F" font-weight="bold">✗ None</text>
    <text x="830" y="150" font-size="10" text-anchor="middle" fill="#1565C0" font-style="italic">emb @ W1 + b1</text>
    <text x="950" y="180" font-size="9" text-anchor="start" fill="#D32F2F">discarded!</text>

    <!-- h1_act -->
    <circle cx="960" cy="175" r="35" fill="#CCCCCC" stroke="#999999" stroke-width="2"/>
    <text x="960" y="175" font-size="12" font-weight="bold" text-anchor="middle" fill="#666">h1_act</text>
    <text x="960" y="225" font-size="10" text-anchor="middle" fill="#D32F2F" font-weight="bold">✗ None</text>
    <text x="960" y="150" font-size="10" text-anchor="middle" fill="#1565C0" font-style="italic">tanh(h1)</text>
    <text x="1020" y="180" font-size="9" text-anchor="start" fill="#D32F2F">discarded!</text>

    <!-- W2 -->
    <circle cx="960" cy="280" r="30" fill="#1976D2" stroke="#0D47A1" stroke-width="2"/>
    <text x="960" y="285" font-size="14" font-weight="bold" text-anchor="middle" fill="white">W2</text>
    <text x="960" y="325" font-size="10" text-anchor="middle" fill="#1976D2" font-weight="bold">✓ .grad</text>
    <text x="1030" y="285" font-size="11" text-anchor="start" fill="#666">(leaf)</text>

    <!-- logits -->
    <circle cx="830" cy="360" r="35" fill="#CCCCCC" stroke="#999999" stroke-width="2"/>
    <text x="830" y="365" font-size="14" font-weight="bold" text-anchor="middle" fill="#666">logits</text>
    <text x="830" y="410" font-size="10" text-anchor="middle" fill="#D32F2F" font-weight="bold">✗ None</text>
    <text x="830" y="335" font-size="10" text-anchor="middle" fill="#1565C0" font-style="italic">h1_act @ W2 + b2</text>
    <text x="950" y="365" font-size="9" text-anchor="start" fill="#D32F2F">discarded!</text>

    <!-- loss -->
    <circle cx="830" cy="470" r="35" fill="#CCCCCC" stroke="#999999" stroke-width="2"/>
    <text x="830" y="475" font-size="14" font-weight="bold" text-anchor="middle" fill="#666">loss</text>
    <text x="830" y="520" font-size="10" text-anchor="middle" fill="#D32F2F" font-weight="bold">✗ None</text>
    <text x="830" y="445" font-size="10" text-anchor="middle" fill="#1565C0" font-style="italic">cross_entropy(logits)</text>
    <text x="950" y="475" font-size="9" text-anchor="start" fill="#D32F2F">discarded!</text>

    <!-- Edges -->
    <line x1="725" y1="140" x2="800" y2="165" stroke="#666" stroke-width="2" marker-end="url(#arrowgray)"/>
    <line x1="725" y1="210" x2="800" y2="185" stroke="#666" stroke-width="2" marker-end="url(#arrowgray)"/>
    <line x1="865" y1="175" x2="925" y2="175" stroke="#666" stroke-width="2" marker-end="url(#arrowgray)"/>
    <line x1="955" y1="210" x2="840" y2="330" stroke="#666" stroke-width="2" marker-end="url(#arrowgray)"/>
    <line x1="945" y1="295" x2="845" y2="340" stroke="#666" stroke-width="2" marker-end="url(#arrowgray)"/>
    <line x1="830" y1="395" x2="830" y2="435" stroke="#666" stroke-width="2" marker-end="url(#arrowgray)"/>

    <!-- Backprop flow with discard annotations -->
    <text x="600" y="470" font-size="11" font-weight="bold" text-anchor="start" fill="#E65100">Backprop ↑</text>
    <line x1="600" y1="450" x2="600" y2="150" stroke="#E65100" stroke-width="2" marker-end="url(#arroworange)" stroke-dasharray="5,5"/>

    <!-- Discard timing annotations -->
    <text x="620" y="420" font-size="9" text-anchor="start" fill="#D32F2F">Step 1: compute ∂loss/∂logits</text>
    <text x="620" y="432" font-size="9" text-anchor="start" fill="#D32F2F">→ use it → discard immediately</text>

    <text x="620" y="310" font-size="9" text-anchor="start" fill="#D32F2F">Step 2: compute ∂loss/∂h1_act</text>
    <text x="620" y="322" font-size="9" text-anchor="start" fill="#D32F2F">→ use it → discard immediately</text>

    <text x="620" y="200" font-size="9" text-anchor="start" fill="#D32F2F">Step 3: compute ∂loss/∂h1</text>
    <text x="620" y="212" font-size="9" text-anchor="start" fill="#D32F2F">→ use it → discard immediately</text>

    <!-- Legend -->
    <rect x="650" y="560" width="400" height="110" fill="#E3F2FD" stroke="#1976D2" stroke-width="2" rx="5"/>
    <text x="850" y="585" font-size="13" font-weight="bold" text-anchor="middle" fill="#1976D2">
      Only LEAF nodes keep gradients
    </text>
    <text x="850" y="605" font-size="11" text-anchor="middle" fill="#333">
      Intermediate gradients computed → used → discarded
    </text>
    <text x="850" y="622" font-size="11" text-anchor="middle" fill="#333">
      (Memory optimization: only parameters need .grad)
    </text>
    <circle cx="720" cy="642" r="8" fill="#1976D2" stroke="#0D47A1" stroke-width="1"/>
    <text x="740" y="647" font-size="11" text-anchor="start" fill="#333">Leaf: .grad kept ✓</text>
    <circle cx="880" cy="642" r="8" fill="#CCCCCC" stroke="#999999" stroke-width="1"/>
    <text x="900" y="647" font-size="11" text-anchor="start" fill="#333">Intermediate: .grad = None ✗</text>
  </g>

  <!-- Bottom note -->
  <rect x="100" y="700" width="950" height="150" fill="#FFF3E0" stroke="#F57C00" stroke-width="2" rx="5"/>
  <text x="575" y="725" font-size="14" font-weight="bold" text-anchor="middle" fill="#E65100">
    PyTorch with .retain_grad() - Making it behave like Micrograd
  </text>

  <text x="120" y="750" font-size="12" text-anchor="start" fill="#333" font-family="monospace">
    h1.retain_grad()        # Keep ∂loss/∂h1
  </text>
  <text x="120" y="770" font-size="12" text-anchor="start" fill="#333" font-family="monospace">
    h1_act.retain_grad()    # Keep ∂loss/∂h1_act
  </text>
  <text x="120" y="790" font-size="12" text-anchor="start" fill="#333" font-family="monospace">
    logits.retain_grad()    # Keep ∂loss/∂logits
  </text>
  <text x="120" y="810" font-size="12" text-anchor="start" fill="#333" font-family="monospace">
    loss.backward()
  </text>

  <text x="550" y="755" font-size="12" text-anchor="start" fill="#333">
    → Now h1.grad, h1_act.grad, logits.grad are all available!
  </text>
  <text x="550" y="775" font-size="12" text-anchor="start" fill="#333">
    → Behaves like Micrograd (all nodes have .grad)
  </text>
  <text x="550" y="795" font-size="12" text-anchor="start" fill="#333">
    → Useful for debugging gradient flow
  </text>
  <text x="550" y="815" font-size="11" text-anchor="start" fill="#D32F2F" font-style="italic">
    (But uses more memory - only use when needed!)
  </text>

  <!-- Arrow markers -->
  <defs>
    <marker id="arrowgreen" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L0,6 L9,3 z" fill="#2E7D32"/>
    </marker>
    <marker id="arrowgray" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L0,6 L9,3 z" fill="#666"/>
    </marker>
    <marker id="arroworange" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L0,6 L9,3 z" fill="#E65100"/>
    </marker>
  </defs>
</svg>
